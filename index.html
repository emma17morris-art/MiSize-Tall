<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MiSize ‚Äî Prototype</title>
<style>
  :root{
    --brand:#4f7cff; --brand-text:#fff; --bg:#0b0d12; --card:#0f131a;
    --border:#1b2230; --text:#eef1f5; --muted:#aab3c5; --radius:14px;
    --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    --nav-bg:#0f131a; --nav-border:#1b2230;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:var(--font);background:var(--bg);color:var(--text);}
  .container{max-width:980px;margin:0 auto;padding:20px;padding-bottom:92px;}
  .screen{display:none;animation:fade .2s ease-in;} .screen.active{display:block;}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  .row{display:grid;grid-template-columns:1fr;gap:14px;}
  @media (min-width:720px){.row.two{grid-template-columns:1fr 1fr}.row.three{grid-template-columns:repeat(3,1fr)}}
  .card{background:linear-gradient(180deg,#111520,#0d1119);border:1px solid var(--border);border-radius:16px;padding:16px;}
  .toolbar{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;align-items:center}
  .cta{background:var(--brand);color:var(--brand-text);border:0;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer}
  .ghost{background:#182034;color:#eef1f5;border:0;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #2a2f3a;background:#0f131a;color:#eef1f5}
  label{font-size:14px;opacity:.9}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#172034;border:1px solid #223049;font-size:12px}
  .big{font-size:28px;font-weight:800;margin:0}
  .note{font-size:13px;opacity:.85}
  .divider{height:1px;background:#1b2230;margin:14px 0}
  .list{display:grid;gap:10px}
  .list .item{padding:12px;border-radius:12px;background:#0f131a;border:1px solid #202939;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .badge{font-weight:800}
  .success{color:#8ee0b2}.warning{color:#ffd27a}.danger{color:#ff9a9a}
  /* bottom tabs */
  .tabbar{position:fixed;left:0;right:0;bottom:0;background:var(--nav-bg);border-top:1px solid var(--nav-border);display:flex;justify-content:space-around;padding:8px}
  .tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 10px;border-radius:10px;min-width:72px;color:#c9d1e3}
  .tab.active{color:#fff;background:#182034}
  .tab .ico{font-size:18px}.tab .txt{font-size:12px}
  /* region tiles */
  .grid4{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:560px){.grid4{grid-template-columns:1fr 1fr}}
  .tile{display:flex;align-items:center;justify-content:center;height:90px;border-radius:14px;border:1px solid var(--border);background:#0f131a;font-weight:800;letter-spacing:.3px}
</style>
</head>
<body>
<div class="container">

  <!-- HOME: 4 region tiles; for now only UK routes to UK hub -->
  <section id="home" class="screen active">
    <div class="card">
      <h2 class="big">Choose region</h2>
      <p class="note">For now, all features live under <b>UK</b>. Others are placeholders.</p>
      <div class="grid4" style="margin-top:12px;">
        <button class="tile cta" onclick="switchTab('uk')">UK</button>
        <button class="tile ghost" onclick="alert('EU coming soon')">EU</button>
        <button class="tile ghost" onclick="alert('US coming soon')">US</button>
        <button class="tile ghost" onclick="alert('CA coming soon')">CA</button>
      </div>
    </div>
  </section>

  <!-- UK HUB: quick links to all core features -->
  <section id="uk" class="screen">
    <div class="card">
      <h2 class="big">UK</h2>
      <div class="row two spaced">
        <div class="card">
          <h3>Size Finder</h3>
          <p class="note">Brand + category ‚Üí recommended size.</p>
          <button class="cta" onclick="switchTab('sizeFinder')">Open Size Finder</button>
        </div>
        <div class="card">
          <h3>My Sizes</h3>
          <p class="note">See your size across all brands.</p>
          <button class="cta" onclick="switchTab('mySizes')">Open My Sizes</button>
        </div>
      </div>
      <div class="row two spaced">
        <div class="card">
          <h3>Profile</h3>
          <p class="note">Profiles, measurements, cm‚Üîin toggle.</p>
          <button class="cta" onclick="switchTab('measurements')">Open Profile</button>
        </div>
        <div class="card">
          <h3>Converters</h3>
          <p class="note">UK ‚áÑ EU ‚áÑ US, shoes, bra helper.</p>
          <button class="cta" onclick="switchTab('converters')">Open Converters</button>
        </div>
      </div>
      <div class="row two spaced">
        <div class="card">
          <h3>Brand notes</h3>
          <p class="note">How each brand defines lengths & fit.</p>
          <button class="cta" onclick="switchTab('brandNotes'); renderBrandNotes();">Open Brand notes</button>
        </div>
        <div class="card">
          <h3>History</h3>
          <p class="note">Your recent lookups.</p>
          <button class="cta" onclick="switchTab('history'); renderHistory();">Open History</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SIZE FINDER (adds Body type dropdown) -->
  <section id="sizeFinder" class="screen">
    <div class="card">
      <h3>Size Finder</h3>
      <div class="row three">
        <div><label>Brand</label><select id="sf_brand"></select></div>
        <div><label>Category</label><select id="sf_category"></select></div>
        <div>
          <label>Fit preference</label>
          <select id="sf_fit">
            <option value="standard">Standard</option>
            <option value="snug">Snug</option>
            <option value="relaxed">Relaxed</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Body type</label>
          <select id="sf_bodytype">
            <option value="standard">Standard</option>
            <option value="petite">Petite</option>
            <option value="tall">Tall</option>
            <option value="curvy">Curvy</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button class="cta" onclick="computeSize()">Get my size</button>
        <button class="ghost" onclick="switchTab('measurements')">Edit measurements</button>
      </div>
    </div>

    <div id="sf_result" class="card" style="display:none;">
      <h3>Result</h3>
      <p class="big" id="sf_size"></p>
      <p class="note" id="sf_confidence"></p>
      <div class="divider"></div>
      <div id="sf_notes" class="note"></div>
      <div class="toolbar">
        <button class="ghost" onclick="saveHistory()">Save to history</button>
        <button class="ghost" onclick="switchTab('brandNotes'); renderBrandNotes();">See brand notes</button>
      </div>
    </div>
  </section>

  <!-- PROFILE (multi-profile + unit toggle) -->
  <section id="measurements" class="screen">
    <div class="card">
      <h3>Profiles & measurements</h3>
      <p class="note">Stored locally. Internally we save in <b>cm</b>; each profile remembers your preferred display unit.</p>

      <div class="row two">
        <div>
          <label>Active profile</label>
          <select id="prof_select" onchange="onSelectProfile(this.value)"></select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px;">
          <button class="ghost" onclick="newProfile()">New</button>
          <button class="ghost" onclick="renameProfile()">Rename</button>
          <button class="ghost" onclick="deleteProfile()">Delete</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row two">
        <div><label>Profile name</label><input id="m_name" placeholder="e.g., Emma"/></div>
        <div>
          <label>Sex</label>
          <select id="m_sex"><option value="female">Female</option><option value="male">Male</option><option value="child">Child</option></select>
        </div>
      </div>

      <div class="row three">
        <div><label>Height (<span id="lbl_height_unit">cm</span>)</label><input id="m_height" inputmode="decimal"/></div>
        <div><label>Shoulder (<span id="lbl_shoulder_unit">cm</span>)</label><input id="m_shoulder" inputmode="decimal"/></div>
        <div><label>Bust/Chest (<span id="lbl_bust_unit">cm</span>)</label><input id="m_bust" inputmode="decimal"/></div>
        <div><label>Waist (<span id="lbl_waist_unit">cm</span>)</label><input id="m_waist" inputmode="decimal"/></div>
        <div><label>Hip (<span id="lbl_hip_unit">cm</span>)</label><input id="m_hip" inputmode="decimal"/></div>
        <div><label>Inseam (<span id="lbl_inseam_unit">cm</span>)</label><input id="m_inseam" inputmode="decimal"/></div>
        <div><label>Torso (<span id="lbl_torso_unit">cm</span>)</label><input id="m_torso" inputmode="decimal"/></div>
        <div><label>Foot length (<span id="lbl_footlen_unit">cm</span>)</label><input id="m_footlen" inputmode="decimal"/></div>
        <div><label>Bra band (<span id="lbl_band_unit">cm</span>)</label><input id="m_band" inputmode="decimal"/></div>
        <div><label>Cup (A‚ÄìH)</label><input id="m_cup" maxlength="3"/></div>
      </div>

      <div class="toolbar">
        <button class="cta" onclick="saveCurrentProfile()">Save profile</button>
        <button class="ghost" onclick="toggleUnits()">Units: <span id="unitLabel">cm</span></button>
        <span id="saveMsg" class="pill" style="display:none;">Saved ‚úì</span>
      </div>
    </div>
  </section>

  <!-- MY SIZES (across brands) -->
  <section id="mySizes" class="screen">
    <div class="card">
      <h3>My sizes across brands</h3>
      <div class="row two">
        <div>
          <label>Categories</label>
          <select id="ms_category" multiple size="4" style="height:120px;"></select>
          <p class="note">Select one or more categories.</p>
        </div>
        <div>
          <label>Fit preference</label>
          <select id="ms_fit">
            <option value="standard">Standard</option>
            <option value="snug">Snug</option>
            <option value="relaxed">Relaxed</option>
          </select>
          <div style="margin-top:8px;"><button class="cta" onclick="computeAllSizes()">Compute all</button></div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="toolbar">
        <button class="ghost" onclick="copyMySizes()">Copy</button>
        <button class="ghost" onclick="exportMySizesCSV()">Export CSV</button>
        <span class="pill" id="ms_count">‚Äî</span>
      </div>
      <div class="list" id="ms_list"></div>
    </div>
  </section>

  <!-- BRAND NOTES -->
  <section id="brandNotes" class="screen">
    <div class="card">
      <h3>Brand Notes</h3>
      <div id="brandList" class="list"></div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="history" class="screen">
    <div class="card">
      <h3>History</h3>
      <div id="histList" class="list"></div>
    </div>
  </section>

  <!-- CONVERTERS -->
  <section id="converters" class="screen">
    <div class="card">
      <h3>Clothes (UK ‚áÑ EU ‚áÑ US)</h3>
      <div class="row three">
        <div><label>From</label><select id="cw_from"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>To</label><select id="cw_to"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>Value</label><input id="cw_val" placeholder="e.g., 10"></div>
      </div>
      <div class="toolbar"><button class="ghost" onclick="convertClothing()">Convert</button><span class="pill" id="cw_out">‚Äî</span></div>
    </div>

    <div class="card">
      <h3>Shoes</h3>
      <div class="row three">
        <div><label>From</label><select id="sh_from"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>To</label><select id="sh_to"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>Value</label><input id="sh_val" placeholder="e.g., 5"></div>
      </div>
      <div class="toolbar"><button class="ghost" onclick="convertShoes()">Convert</button><span class="pill" id="sh_out">‚Äî</span></div>
    </div>

    <div class="card">
      <h3>Bra helper</h3>
      <div class="row three">
        <div><label>Band (cm)</label><input id="br_band" placeholder="e.g., 75"></div>
        <div><label>Cup</label><input id="br_cup" placeholder="e.g., C"></div>
        <div style="display:flex;align-items:flex-end;"><button class="ghost" onclick="convertBra()">Estimate</button></div>
      </div>
      <div class="toolbar"><span class="pill" id="br_out">‚Äî</span></div>
    </div>
  </section>

  <!-- MISTATS (empty) -->
  <section id="stats" class="screen">
    <div class="card"><h3>MiStats</h3><p class="note">Reserved for future weight tracking.</p></div>
  </section>

  <!-- SETTINGS (placeholder) -->
  <section id="settings" class="screen">
    <div class="card"><h3>Settings</h3><p class="note">Placeholder</p></div>
  </section>

</div>

<!-- Bottom Tab Bar -->
<nav class="tabbar">
  <button class="tab active" id="tab_home" onclick="switchTab('home')"><span class="ico">üè†</span><span class="txt">Home</span></button>
  <button class="tab" id="tab_measurements" onclick="switchTab('measurements')"><span class="ico">üë§</span><span class="txt">Profile</span></button>
  <button class="tab" id="tab_mySizes" onclick="switchTab('mySizes')"><span class="ico">üìã</span><span class="txt">My Sizes</span></button>
  <button class="tab" id="tab_stats" onclick="switchTab('stats')"><span class="ico">üìä</span><span class="txt">MiStats</span></button>
  <button class="tab" id="tab_settings" onclick="switchTab('settings')"><span class="ico">‚öôÔ∏è</span><span class="txt">Settings</span></button>
</nav>

<script>
/* ------------- tiny helpers ------------- */
function $(id){return document.getElementById(id);}
function in2cm(v){const n=parseFloat(v);return isNaN(n)?null:n*2.54}
function cm2in(v){const n=parseFloat(v);return isNaN(n)?'':(n/2.54).toFixed(1)}

function switchTab(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  (document.getElementById(id)||$('home')).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const tab=$('tab_'+id); if(tab) tab.classList.add('active');
  if(id==='brandNotes') renderBrandNotes();
  if(id==='history') renderHistory();
  if(id==='mySizes') initMySizesSelectors();
}

/* ------------- data loading ------------- */
let BRANDS=[], CHARTS=[];
const CATEGORIES=['Women ‚Ä¢ Dresses','Women ‚Ä¢ Jeans','Shoes (UK)'];

async function loadData(){
  try{
    BRANDS = await (await fetch('brands.json')).json();
    CHARTS = await (await fetch('charts.json')).json();
    initSelectors();
  }catch(e){
    console.error('Failed to load JSON:', e);
    alert('Could not load brands.json / charts.json ‚Äî make sure both are in the repo root.');
  }
}
function initSelectors(){
  const b=$('sf_brand'); if(b){ b.innerHTML=''; BRANDS.forEach(br=>{const o=document.createElement('option');o.value=br.id;o.textContent=br.name;b.appendChild(o);}); }
  const c=$('sf_category'); if(c){ c.innerHTML=''; CATEGORIES.forEach(cat=>{const o=document.createElement('option');o.value=cat;o.textContent=cat;c.appendChild(o);}); }
}

/* ------------- profiles + units ------------- */
const LS_PROFILES='profiles', LS_ACTIVE='activeProfileId';
let currentUnit='cm';
function uid(){return 'p_'+Math.random().toString(36).slice(2,8)}
function readProfiles(){try{return JSON.parse(localStorage.getItem(LS_PROFILES)||'[]')}catch(e){return[]}}
function writeProfiles(list){localStorage.setItem(LS_PROFILES, JSON.stringify(list))}
function getActiveId(){return localStorage.getItem(LS_ACTIVE)||null}
function setActiveId(id){localStorage.setItem(LS_ACTIVE,id)}

function migrateLegacyIfAny(){
  const old=(()=>{try{return JSON.parse(localStorage.getItem('measurements')||'null')}catch(e){return null}})();
  const profs=readProfiles();
  if(!profs.length && old){
    const id=uid();
    const imported={ id, unit:'cm', name: old.name||'Me', ...old, updatedAt:new Date().toISOString() };
    writeProfiles([imported]); setActiveId(id); localStorage.removeItem('measurements');
  }
}
function setUnitLabels(u){
  ['lbl_height_unit','lbl_shoulder_unit','lbl_bust_unit','lbl_waist_unit','lbl_hip_unit','lbl_inseam_unit','lbl_torso_unit','lbl_footlen_unit','lbl_band_unit','unitLabel']
    .forEach(id=>{const el=$(id); if(el) el.textContent=u;});
}
function convertFormUnits(toUnit){
  const f=2.54;
  ['m_height','m_shoulder','m_bust','m_waist','m_hip','m_inseam','m_torso','m_footlen','m_band'].forEach(id=>{
    const el=$(id); if(!el||el.value==='') return;
    let v=parseFloat(el.value); if(isNaN(v)) return;
    if(currentUnit==='cm'&&toUnit==='in') el.value=(v/f).toFixed(1);
    if(currentUnit==='in'&&toUnit==='cm') el.value=(v*f).toFixed(1);
  });
}
function toggleUnits(){
  const newUnit=currentUnit==='cm'?'in':'cm';
  convertFormUnits(newUnit); currentUnit=newUnit; setUnitLabels(newUnit);
  const active=getActiveId(); if(!active) return; const profs=readProfiles(); const p=profs.find(x=>x.id===active); if(!p) return;
  p.unit=newUnit; writeProfiles(profs);
}
function renderProfileSelect(){
  let profs=readProfiles(); const sel=$('prof_select'); if(!sel) return;
  sel.innerHTML='';
  if(!profs.length){
    const id=uid();
    const first={ id,name:'Me',sex:'female',unit:'cm',
      height:null,shoulder:null,bust:null,waist:null,hip:null,inseam:null,torso:null,footlen:null,band:null,cup:'',
      updatedAt:new Date().toISOString()
    };
    writeProfiles([first]); setActiveId(id); profs=readProfiles();
  }
  const active=getActiveId()||profs[0]?.id; if(!getActiveId()&&active) setActiveId(active);
  readProfiles().forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.name;if(p.id===active)o.selected=true; sel.appendChild(o);});
  fillFormFromProfile(active);
}
function onSelectProfile(id){ setActiveId(id); fillFormFromProfile(id); }
function newProfile(){
  const name=prompt('Name for new profile?','New profile'); if(!name) return;
  const id=uid();
  const base={ id,name,sex:'female',unit:'cm',
    height:null,shoulder:null,bust:null,waist:null,hip:null,inseam:null,torso:null,footlen:null,band:null,cup:'',
    updatedAt:new Date().toISOString()
  };
  const profs=readProfiles(); profs.push(base); writeProfiles(profs); setActiveId(id); renderProfileSelect();
}
function renameProfile(){
  const active=getActiveId(); if(!active) return; const profs=readProfiles();
  const p=profs.find(x=>x.id===active); if(!p) return;
  const name=prompt('Rename to:', p.name); if(!name) return;
  p.name=name; p.updatedAt=new Date().toISOString(); writeProfiles(profs); renderProfileSelect();
}
function deleteProfile(){
  const active=getActiveId(); if(!active) return; const profs=readProfiles();
  if(profs.length<=1){ alert('Keep at least one profile.'); return; }
  const p=profs.find(x=>x.id===active);
  if(!confirm(`Delete profile "${p?.name||'this'}"?`)) return;
  const next=profs.find(x=>x.id!==active)?.id;
  writeProfiles(profs.filter(x=>x.id!==active)); setActiveId(next); renderProfileSelect();
}
function fillFormFromProfile(id){
  const profs=readProfiles(); const p=profs.find(x=>x.id===id)||profs[0]; if(!p) return;
  currentUnit=(p.unit==='in')?'in':'cm'; setUnitLabels(currentUnit);
  if($('m_name')) $('m_name').value=p.name??''; if($('m_sex')) $('m_sex').value=p.sex??'female';
  const put=(fid,val)=>{const el=$(fid); if(!el) return; if(val==null){el.value='';return;} el.value=(currentUnit==='in')?cm2in(val):val;}
  put('m_height',p.height); put('m_shoulder',p.shoulder); put('m_bust',p.bust); put('m_waist',p.waist); put('m_hip',p.hip);
  put('m_inseam',p.inseam); put('m_torso',p.torso); put('m_footlen',p.footlen); put('m_band',p.band);
  if($('m_cup')) $('m_cup').value=p.cup??'';
}
function readFormToObject(){
  const read=(fid)=>{const v=$(fid)?.value; if(v==null||v==='') return null; const n=parseFloat(v); if(isNaN(n)) return null; return (currentUnit==='in')?n*2.54:n;}
  return{
    name:$('m_name')?.value||'Me', sex:$('m_sex')?.value||'female', unit:currentUnit,
    height:read('m_height'), shoulder:read('m_shoulder'), bust:read('m_bust'),
    waist:read('m_waist'), hip:read('m_hip'), inseam:read('m_inseam'), torso:read('m_torso'),
    footlen:read('m_footlen'), band:read('m_band'), cup:($('m_cup')?.value||'').toUpperCase()
  };
}
function saveCurrentProfile(){
  const id=getActiveId(); if(!id) return; const profs=readProfiles(); const idx=profs.findIndex(x=>x.id===id);
  const updated={ ...profs[idx], ...readFormToObject(), id, updatedAt:new Date().toISOString() }; profs[idx]=updated; writeProfiles(profs);
  const msg=$('saveMsg'); if(msg){ msg.style.display='inline-block'; setTimeout(()=> msg.style.display='none', 1600); }
  renderProfileSelect();
}
function getMeasurements(){ const id=getActiveId(); const profs=readProfiles(); return profs.find(x=>x.id===id)||profs[0]||{}; }
function getMeasurementsCm(){ return getMeasurements(); }
function loadMeasurements(){ migrateLegacyIfAny(); renderProfileSelect(); }

/* ------------- size finder ------------- */
function computeSize(){
  const brandId=$('sf_brand').value, cat=$('sf_category').value, fit=$('sf_fit').value, body=$('sf_bodytype').value;
  const meas=getMeasurementsCm(); const brand=BRANDS.find(b=>b.id===brandId);
  const table=CHARTS.filter(r=>r.brandId===brandId && r.category===cat)
    .map(r=>({size:r.size,bust:r.bust??null,waist:r.waist??null,hip:r.hip??null,footLen:r.footLen??null}));
  if(!brand || table.length===0){ showResult('‚Äî','Low','No data for this brand/category yet.',[]); return; }

  let dims=[]; if(cat.includes('Dresses')) dims=['bust','waist','hip'];
               if(cat.includes('Jeans'))   dims=['waist','hip'];
               if(cat.includes('Shoes'))   dims=['footLen'];

  const wants={}; dims.forEach(d=> wants[d]=meas[d==='footLen'?'footlen':d]);
  const used=dims.filter(d=> wants[d]!=null); if(!used.length){ showResult('‚Äî','Low','Please add measurements for this category.',[]); return; }

  const scored=table.map(r=>({ size:r.size, score:used.reduce((s,d)=> s+Math.abs((r[d]||0)-wants[d]),0) }))
                    .sort((a,b)=>a.score-b.score);

  let pick=scored[0]; if(!pick){ showResult('‚Äî','Low','No matching sizes found.',[]); return; }
  if(scored[1]){ const diff=scored[1].score-scored[0].score; if(fit==='relaxed' && diff<2) pick=scored[1]; }

  const avg=pick.score/used.length; let conf='Medium'; if(avg<1.2 && used.length>=2) conf='High'; if(avg>3.0) conf='Low';
  const notes=[]; 
  notes.push(`Body type: ${body}`);
  if(fit==='snug') notes.push('Snug fit chosen. If unsure, consider one size up.');
  if(fit==='relaxed') notes.push('Relaxed fit chosen. For closer fit, go down.');
  if(cat.includes('Jeans') && meas.inseam && brand?.lengths_cm){
    const len=mapInseamToLengthFromBrand(brand.lengths_cm, meas.inseam);
    // inches helper
    const cm=brand.lengths_cm[len]; const inches = cm ? (cm/2.54).toFixed(1) : null;
    notes.push(`Suggested length: ${len.toUpperCase()}${inches?` (~${inches} in)`:''}.`);
  }
  if(brand?.notes) notes.push(`Brand note: ${brand.notes}`);

  showResult(pick.size, conf, null, notes);
}
function showResult(size,conf,message,notes){
  const box=$('sf_result'); if(!box) return; box.style.display='block';
  $('sf_size').innerHTML = size==='‚Äî' ? 'No result' : `Your best size: <span class="badge">${size}</span>`;
  $('sf_confidence').innerHTML = `Confidence: <span class="${conf==='High'?'success':conf==='Low'?'danger':'warning'} badge">${conf}</span>`;
  $('sf_notes').innerHTML = message ? message : (notes||[]).map(n=>`<div>‚Ä¢ ${n}</div>`).join('');
  window.scrollTo({top:0, behavior:'smooth'});
  window._lastResult = { when:new Date().toISOString(), brand:$('sf_brand').value, category:$('sf_category').value, size:size, conf:conf };
}

/* ------------- brand notes ------------- */
function renderBrandNotes(){
  const wrap=$('brandList'); if(!wrap) return; wrap.innerHTML='';
  BRANDS.forEach(b=>{
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.innerHTML=`<div><strong>${b.name}</strong></div><div class="note">${b.notes||''}</div>`;
    const L=b.lengths_cm||{};
    const right=document.createElement('div'); right.innerHTML=
      `<span class="pill">Short ~${L.short??'‚Äì'}cm</span>
       <span class="pill">Regular ~${L.regular??'‚Äì'}cm</span>
       <span class="pill">Long ~${L.long??'‚Äì'}cm</span>
       <span class="pill">Tall ~${L.tall??'‚Äì'}cm</span>`;
    div.appendChild(left); div.appendChild(right); wrap.appendChild(div);
  });
}

/* ------------- history ------------- */
function getHistory(){try{return JSON.parse(localStorage.getItem('history')||'[]')}catch(e){return[]}}
function saveHistory(){ if(!window._lastResult) return; const h=getHistory(); h.unshift(window._lastResult); localStorage.setItem('history', JSON.stringify(h.slice(0,20))); alert('Saved.'); }
function renderHistory(){
  const wrap=$('histList'); if(!wrap) return; wrap.innerHTML='';
  const h=getHistory(); if(!h.length){ wrap.innerHTML='<div class="note">No lookups yet.</div>'; return; }
  h.forEach(item=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><div><strong>${item.brand}</strong> ‚Ä¢ ${item.category}</div>
      <div class="note">${new Date(item.when).toLocaleString()} ‚Ä¢ Recommended: <span class="badge">${item.size}</span> ‚Ä¢ ${item.conf} confidence</div></div>
      <div class="pill">Saved</div>`;
    wrap.appendChild(div);
  });
}

/* ------------- converters ------------- */
function convertClothing(){
  const from=$('cw_from').value,to=$('cw_to').value,val=$('cw_val').value.trim();
  const map=[{UK:'8',EU:'36',US:'4'},{UK:'10',EU:'38',US:'6'},{UK:'12',EU:'40',US:'8'},{UK:'14',EU:'42',US:'10'},{UK:'16',EU:'44',US:'12'},{UK:'18',EU:'46',US:'14'}];
  const row=map.find(r=>r[from]===val); $('cw_out').textContent=row?row[to]:'‚Äî';
}
function convertShoes(){
  const from=$('sh_from').value,to=$('sh_to').value,val=$('sh_val').value.trim();
  const map=[{UK:'4',EU:'37',US:'6.5'},{UK:'5',EU:'38',US:'7.5'},{UK:'6',EU:'39',US:'8.5'},{UK:'7',EU:'40',US:'9.5'}];
  const row=map.find(r=>r[from]===val); $('sh_out').textContent=row?row[to]:'‚Äî';
}
function convertBra(){
  const band=parseFloat($('br_band').value); const cup=($('br_cup').value||'').toUpperCase();
  if(!band||!cup){ $('br_out').textContent=''; return; }
  let inches=band/2.54; let bandUK=Math.round(inches/2)*2; bandUK=Math.min(Math.max(bandUK,28),42);
  const sister=[bandUK-2,bandUK+2].filter(x=>x>=28&&x<=42).join('/'); $('br_out').textContent=`UK ~ ${bandUK}${cup} (sisters: ${sister}${cup})`;
}

/* ------------- inseam helper ------------- */
function mapInseamToLengthFromBrand(lengths, cm){
  const entries=Object.entries(lengths||{}); if(!entries.length) return 'regular';
  const sorted=entries.map(([k,v])=>({k,d:Math.abs(v-cm)})).sort((a,b)=>a.d-b.d);
  return sorted[0].k;
}

/* ------------- My Sizes (across brands) ------------- */
function initMySizesSelectors(){
  const sel=$('ms_category'); if(!sel) return; sel.innerHTML='';
  CATEGORIES.forEach(cat=>{const o=document.createElement('option');o.value=cat;o.textContent=cat;sel.appendChild(o);});
  if(sel.options.length) sel.options[0].selected=true;
}
function scoreFor(brandId, cat, meas, fit){
  const brand=BRANDS.find(b=>b.id===brandId);
  const rows=CHARTS.filter(r=>r.brandId===brandId && r.category===cat);
  if(!brand || rows.length===0) return null;

  let dims=[]; if(cat.includes('Dresses')) dims=['bust','waist','hip'];
               if(cat.includes('Jeans'))   dims=['waist','hip'];
               if(cat.includes('Shoes'))   dims=['footLen'];

  const wants={}; dims.forEach(d=> wants[d]=meas[d==='footLen'?'footlen':d]);
  const used=dims.filter(d=> wants[d]!=null); if(!used.length) return {size:'‚Äî',conf:'Low',notes:['Add measurements for this category.']};

  const table=rows.map(r=>({ size:r.size,bust:r.bust??null,waist:r.waist??null,hip:r.hip??null,footLen:r.footLen??null }));
  const scored=table.map(r=>({ size:r.size, score:used.reduce((s,d)=> s+Math.abs((r[d]||0)-wants[d]),0) }))
                    .sort((a,b)=>a.score-b.score);

  let pick=scored[0]; if(!pick) return {size:'‚Äî',conf:'Low',notes:['No matching sizes found.']};
  if(scored[1]){ const diff=scored[1].score-scored[0].score; if(fit==='relaxed'&&diff<2) pick=scored[1]; }

  const avg=pick.score/used.length; let conf='Medium'; if(avg<1.2&&used.length>=2) conf='High'; if(avg>3.0) conf='Low';
  const notes=[]; if(fit==='snug') notes.push('Snug fit chosen.'); if(fit==='relaxed') notes.push('Relaxed fit chosen.');
  if(cat.includes('Jeans') && meas.inseam && brand?.lengths_cm){
    const len=mapInseamToLengthFromBrand(brand.lengths_cm, meas.inseam);
    const cm=brand.lengths_cm[len]; const inches=cm ? (cm/2.54).toFixed(1) : null;
    notes.push(`Length: ${len.toUpperCase()}${inches?` (~${inches} in)`:''}`);
  }
  if(brand?.notes) notes.push(`Brand note: ${brand.notes}`);
  return { size:pick.size, conf, notes };
}
function computeAllSizes(){
  const sel=$('ms_category'); const fit=$('ms_fit').value; const meas=getMeasurementsCm();
  const cats=Array.from(sel.selectedOptions).map(o=>o.value); const results=[];
  cats.forEach(cat=>{
    BRANDS.forEach(b=>{
      const res=scoreFor(b.id,cat,meas,fit); if(!res) return;
      results.push({brandId:b.id,brandName:b.name,category:cat,size:res.size,conf:res.conf,notes:res.notes||[]});
    });
  });
  const rank={High:0,Medium:1,Low:2};
  results.sort((a,b)=> a.category.localeCompare(b.category) || (rank[a.conf]??9)-(rank[b.conf]??9) || a.brandName.localeCompare(b.brandName));
  renderMySizes(results);
}
function renderMySizes(list){
  const wrap=$('ms_list'); if(!wrap) return; wrap.innerHTML='';
  $('ms_count').textContent=`${list.length} results`;
  if(!list.length){ wrap.innerHTML='<div class="note">No results ‚Äî add measurements or select a category.</div>'; return; }
  list.forEach(row=>{
    const item=document.createElement('div'); item.className='item';
    const confClass = row.conf==='High'?'success':row.conf==='Low'?'danger':'warning';
    const notesHtml=(row.notes||[]).map(n=>`<div>‚Ä¢ ${n}</div>`).join('');
    item.innerHTML=`
      <div>
        <div><strong>${row.brandName}</strong> ‚Ä¢ <span class="note">${row.category}</span></div>
        <div class="note">${notesHtml}</div>
      </div>
      <div style="text-align:right;">
        <div class="badge">Size: ${row.size}</div>
        <div class="note ${confClass}">Confidence: ${row.conf}</div>
      </div>`;
    wrap.appendChild(item);
  });
  window._lastMySizes=list;
}
function copyMySizes(){
  const list=window._lastMySizes||[]; if(!list.length){ alert('Nothing to copy yet.'); return; }
  const text=list.map(r=>`${r.category} ‚Äî ${r.brandName}: ${r.size} (${r.conf})`).join('\n');
  navigator.clipboard?.writeText(text).then(()=>alert('Copied sizes!'),()=>alert('Copy failed.'));
}
function exportMySizesCSV(){
  const list=window._lastMySizes||[]; if(!list.length){ alert('Nothing to export yet.'); return; }
  const header=['Category','Brand','Size','Confidence','Notes'];
  const rows=list.map(r=>[`"${r.category}"`,`"${r.brandName}"`,`"${r.size}"`,`"${r.conf}"`,`"${(r.notes||[]).join('; ').replace(/"/g,'""')}"`]);
  const csv=[header.join(','),...rows.map(r=>r.join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='my-sizes.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ------------- boot ------------- */
(async () => {
  await loadData();
  loadMeasurements();
})();
</script>
</body>
</html>
