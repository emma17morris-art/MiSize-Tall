<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MiSize - Size Finder & Body Tracker!</title>
  <style>
    :root{
      --brand:#8A2BE2;--bg:#2b1055;--card:#111520;--border:#1b2230;
      --text:#eef1f5;--muted:#aab3c5;--blue:#1d4ed8;--green:#10b981;--orange:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}

    .topbar{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(15,19,26,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:8px 16px}
    .topbar-inner{display:flex;gap:12px;align-items:center;max-width:1200px;margin:0 auto}
    .logo{font-size:18px;font-weight:900;color:#cfe0ff;margin-right:8px}
    .pill-group{display:flex;gap:6px;align-items:center}
    .pill{border:1px solid rgba(255,255,255,.12);background:#151a3a;color:#c9d3ea;font-weight:700;font-size:11px;padding:6px 10px;border-radius:999px;cursor:pointer;transition:.2s}
    .pill.active{background:var(--blue);color:#fff;border-color:var(--blue)}
    .spacer{flex:1}

    .screen{display:none;padding-top:80px;padding-bottom:80px;height:100vh;overflow-y:auto}
    .screen.active{display:block}

    .main-container{padding-top:80px;padding-bottom:80px;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
    .title{font-size:48px;font-weight:900;margin:0 0 12px}
    .subtitle{font-size:18px;color:var(--muted);margin:0}
    .region-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;width:100%;max-width:600px;padding:0 20px}
    @media(min-width:1024px){.region-grid{grid-template-columns:repeat(4,1fr);max-width:900px}}
    .region-tile{background:var(--blue);border-radius:16px;padding:32px 20px;cursor:pointer;transition:.3s cubic-bezier(.4,0,.2,1);border:2px solid transparent;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:140px}
    .region-tile:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(29,78,216,.3);border-color:rgba(255,255,255,.2)}
    .region-flag{font-size:40px;margin-bottom:12px}
    .region-name{font-size:20px;font-weight:800;color:#fff;margin:0}

    .hub-container{padding:40px 20px;max-width:800px;margin:0 auto}
    .hub-header{text-align:center;margin-bottom:32px}
    .hub-title{font-size:36px;font-weight:900;margin:0 0 8px}
    .hub-subtitle{font-size:16px;color:var(--muted);margin:0}

    .hub-tiles,.hub-tiles-5{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
    .hub-tiles-5 .hub-tile:last-child{grid-column:span 2}
    .hub-tile{background:var(--blue);border-radius:16px;padding:28px 20px;cursor:pointer;transition:.3s;border:2px solid transparent;text-align:center;color:#fff;font-size:18px;font-weight:800;min-height:110px;display:flex;align-items:center;justify-content:center}
    .hub-tile:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(29,78,216,.3);border-color:rgba(255,255,255,.2)}

    .content-container{max-width:800px;margin:0 auto;padding:20px}
    .form-container{max-width:600px;margin:0 auto;padding:20px}
    .form-group{margin-bottom:18px}
    .form-label{display:block;margin-bottom:8px;font-weight:700}
    .form-select,.form-input{width:100%;padding:12px 16px;background:var(--card);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:16px;font-weight:600}

    .btn{padding:14px 20px;border:0;border-radius:12px;font-weight:700;font-size:16px;cursor:pointer;transition:.3s}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-secondary{background:var(--card);color:var(--text);border:2px solid var(--border)}
    .btn:hover{transform:translateY(-2px)}

    .brand-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px}
    .brand-card{background:var(--card);border-radius:12px;padding:16px;border:2px solid var(--border)}
    .brand-name{font-size:18px;font-weight:800;margin-bottom:8px}
    .brand-size{background:var(--brand);color:#fff;padding:6px 10px;border-radius:8px;font-size:14px;font-weight:700;display:inline-block;margin-bottom:8px}
    .confidence-indicator{background:var(--green);color:#fff;padding:2px 6px;border-radius:4px;font-size:12px;font-weight:600;margin-left:8px}

    .system-status{background:var(--card);border-radius:12px;padding:16px;margin:16px 0;border:2px solid var(--border)}
    .status-indicator{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .status-online{background:var(--green)} .status-loading{background:var(--orange)} .status-offline{background:var(--muted)}

    .history-list{background:var(--card);border-radius:12px;overflow:hidden;border:2px solid var(--border)}
    .history-item{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .history-item:last-child{border-bottom:none}
    .history-date{font-size:12px;color:var(--muted)}

    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,19,26,.9);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:100}
    .nav-item{flex:1;padding:14px 10px;background:transparent;color:#cfd7ea;font-weight:700;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .nav-item.active,.nav-item:hover{color:var(--brand)}

    /* Debug panel */
    .debug-panel{position:fixed;top:60px;right:0;background:var(--card);border:2px solid var(--orange);border-radius:8px 0 0 8px;padding:12px;max-width:300px;font-size:11px;z-index:999;transform:translateX(280px);transition:transform .3s}
    .debug-panel.open{transform:translateX(0)}
    .debug-tab{position:absolute;left:-30px;top:50%;background:var(--orange);color:#fff;padding:8px 6px;border-radius:6px 0 0 6px;cursor:pointer;writing-mode:vertical-rl;font-weight:bold;font-size:10px}
    .loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:var(--brand);animation:spin 1s ease-in-out infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

  <body>
  <!-- Debug Panel -->
  <div id="debug-panel" class="debug-panel">
    <div class="debug-tab" onclick="toggleDebugPanel()">DEBUG</div>
    <div id="debug-content" style="color:var(--text);line-height:1.4;">
      <div style="color:var(--orange);font-weight:bold;margin-bottom:8px;">üîß System Status</div>
      <div id="debug-info">Loading...</div>
      <button onclick="refreshDebug()" class="btn btn-primary" style="font-size:12px;margin-top:8px;padding:8px 10px;">Refresh</button>
    </div>
  </div>

  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo">MiSize</div>
      <div class="pill-group" id="bodytype-pills">
        <button class="pill active" data-type="standard">Std</button>
        <button class="pill" data-type="petite">Petite</button>
        <button class="pill" data-type="tall">Tall</button>
        <button class="pill" data-type="plus">Plus</button>
      </div>
      <div class="spacer"></div>
      <div class="pill-group" id="unit-pills">
        <button class="pill active" data-unit="cm">cm</button>
        <button class="pill" data-unit="inch">inch</button>
      </div>
    </div>
  </div>

  <!-- Home -->
  <div id="home" class="screen active">
    <div class="main-container">
      <div class="header">
        <h1 class="title">Welcome to MiSize</h1>
        <p class="subtitle">Your personal size finder and body tracker with AI-powered sizing!</p>
      </div>

      <div class="system-status">
        <div class="status-indicator">
          <div class="status-dot status-loading" id="system-status-dot"></div>
          <span id="system-status-text">Initializing intelligent sizing system...</span>
        </div>
      </div>

      <div class="region-grid">
        <div class="region-tile" onclick="enterHub('UK')"><span class="region-flag">üá¨üáß</span><h3 class="region-name">UK</h3></div>
        <div class="region-tile" onclick="enterHub('EU')"><span class="region-flag">üá™üá∫</span><h3 class="region-name">EU</h3></div>
        <div class="region-tile" onclick="enterHub('US')"><span class="region-flag">üá∫üá∏</span><h3 class="region-name">US</h3></div>
        <div class="region-tile" onclick="enterHub('CA')"><span class="region-flag">üá®üá¶</span><h3 class="region-name">CA</h3></div>
      </div>
    </div>
  </div>

      <!-- UK Hub -->
  <div id="uk-hub" class="screen">
    <div class="hub-container">
      <div class="hub-header">
        <div style="font-size:60px;margin-bottom:8px">üá¨üáß</div>
        <h2 class="hub-title">UK Hub</h2>
        <p class="hub-subtitle">United Kingdom sizing & tracking with AI precision</p>
      </div>

      <div class="system-status">
        <div class="status-indicator">
          <div class="status-dot status-online"></div>
          <span id="uk-system-status-text">Brand data ready.</span>
        </div>
      </div>

      <div class="hub-tiles-5">
        <div class="hub-tile" onclick="goToScreen('uk-sizefinder')">AI Size Finder</div>
        <div class="hub-tile" onclick="goToScreen('uk-mysizes')">My Accurate Sizes</div>
        <div class="hub-tile" onclick="goToScreen('uk-brandnotes')">Brand Intelligence</div>
        <div class="hub-tile" onclick="goToScreen('uk-history')">Search History</div>
        <div class="hub-tile" onclick="goToScreen('uk-converters')">Size Converters</div>
      </div>
    </div>
  </div>

  <!-- UK Size Finder -->
  <div id="uk-sizefinder" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß AI Size Finder</h2>
        <p class="hub-subtitle">Find your perfect size using real brand measurements</p>
      </div>

      <div class="form-container">
        <div class="form-group">
          <label class="form-label">Brand</label>
          <select class="form-select" id="uk-brand-select">
            <option value="">Select a brand...</option>
            <option>ASOS</option>
            <option>Zara</option>
            <option>H&M</option>
            <option>Marks & Spencer</option>
            <option>Next</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="uk-category-select">
            <option value="">Select category...</option>
            <option>Women's Jeans</option>
            <option>Women's Dresses</option>
            <option>Women's Tops</option>
            <option>Women's Shoes</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Fit Preference</label>
          <select class="form-select" id="uk-fit-select">
            <option value="">Select fit...</option>
            <option value="Snug">Snug (Size down)</option>
            <option value="Standard">Standard (True to measurements)</option>
            <option value="Relaxed">Relaxed (Size up)</option>
          </select>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="getMySize()"><span id="size-finder-btn-text">Get My Perfect Size</span></button>
          <button class="btn btn-secondary" onclick="saveToHistory()">Save to History</button>
        </div>

        <div id="size-result" style="display:none;margin-top:16px;padding:16px;background:var(--card);border-radius:12px;border:2px solid var(--green)"></div>
      </div>
    </div>
  </div>

  <!-- UK My Sizes -->
  <div id="uk-mysizes" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">My Accurate Sizes</h2>
        <p class="hub-subtitle">Based on your measurements: 36" bust, 34" waist, 38" hips</p>
        <p style="font-size:14px;color:var(--muted)">All sizes calculated from brand charts</p>
      </div>

      <div class="system-status">
        <div class="status-indicator">
          <div class="status-dot status-online"></div><span>Showing sizes with 70%+ confidence</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Category Filter</label>
        <select class="form-select" id="mysizes-category">
          <option value="">All categories</option>
          <option>Women's Jeans</option>
          <option>Women's Dresses</option>
          <option>Women's Tops</option>
          <option>Women's Shoes</option>
        </select>
      </div>

      <div class="brand-grid" id="my-sizes-grid">
        <div style="text-align:center;padding:24px;grid-column:1/-1;">
          <div class="loading-spinner"></div><p>Loading your accurate sizes‚Ä¶</p>
        </div>
      </div>
    </div>
  </div>

  <!-- UK Brand Notes -->
  <div id="uk-brandnotes" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß Brand Intelligence</h2>
        <p class="hub-subtitle">Quick notes about UK brands and their sizing</p>
      </div>
      <div class="brand-grid" id="brand-notes-grid"></div>
    </div>
  </div>

  <!-- UK History -->
  <div id="uk-history" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß Search History</h2>
        <p class="hub-subtitle">Your past AI size finder searches</p>
      </div>
      <div class="history-list" id="uk-history-list"></div>
    </div>
  </div>

  <!-- UK Converters (placeholder tiles) -->
  <div id="uk-converters" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß Size Converters</h2>
        <p class="hub-subtitle">Convert between UK, US, CA, EU sizes</p>
      </div>
      <div class="hub-tiles">
        <div class="hub-tile" onclick="alert('Dress converter coming soon')">Dress Sizes</div>
        <div class="hub-tile" onclick="alert('Jean converter coming soon')">Jean Sizes</div>
        <div class="hub-tile" onclick="alert('Top converter coming soon')">Top Sizes</div>
        <div class="hub-tile" onclick="alert('Shoe converter coming soon')">Shoe Sizes</div>
      </div>
    </div>
  </div>

      <!-- Help -->
  <div id="help" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">Help & Support</h2>
        <p class="hub-subtitle">Get started and find answers</p>
      </div>

      <div class="brand-card">
        <h3 style="margin:0 0 8px;color:var(--brand)">üì± How to Use MiSize</h3>
        <p style="margin:0 0 6px">1) Pick your region ‚Ä¢ 2) Check Settings to set your profile ‚Ä¢ 3) Use the UK AI Size Finder.</p>
        <p style="margin:0;color:var(--muted)">AI compares your measurements with brand charts to recommend the best size + confidence.</p>
      </div>

      <div class="hub-tiles" style="margin-top:16px">
        <div class="hub-tile" onclick="reportIssue()">üêõ Report Issue</div>
        <div class="hub-tile" onclick="alert('Guides coming soon')">üìè Measurement Guides</div>
      </div>
    </div>
  </div>

  <!-- UK Settings -->
  <div id="uk-settings" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß Settings</h2>
        <p class="hub-subtitle">Manage your profiles and preferences</p>
      </div>

      <div class="brand-card">
        <h3 style="margin:0 0 8px;color:var(--brand)">ü§ñ AI System</h3>
        <div class="status-indicator"><div class="status-dot status-online"></div><span id="ai-status-text">AI sizing active - Last updated: <span id="last-update-time">Never</span></span></div>
      </div>

      <div class="brand-card">
        <h3 style="margin:0 0 8px;color:var(--brand)">üë§ Profiles</h3>
        <div class="form-group">
          <label class="form-label">Select Profile</label>
          <select class="form-select" id="measurement-profile-select"></select>
        </div>

        <div class="brand-grid">
          <div class="brand-card">
            <div class="form-group"><label class="form-label">Weight</label><input id="weight" type="number" class="form-input" placeholder="80"/></div>
            <div class="form-group"><label class="form-label">Chest/Bust (in)</label><input id="chest" type="number" class="form-input" placeholder="36"/></div>
          </div>
          <div class="brand-card">
            <div class="form-group"><label class="form-label">Waist (in)</label><input id="waist" type="number" class="form-input" placeholder="34"/></div>
            <div class="form-group"><label class="form-label">Hips (in)</label><input id="hips" type="number" class="form-input" placeholder="38"/></div>
          </div>
        </div>

        <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="saveMeasurementsToProfile()">Save Measurements & Update</button>
      </div>
    </div>
  </div>

      <!-- Simple placeholders for other regions -->
  <div id="eu-hub" class="screen"><div class="hub-container"><div class="hub-header"><div style="font-size:60px">üá™üá∫</div><h2 class="hub-title">EU Hub</h2><p class="hub-subtitle">European sizing & tracking</p></div><div class="hub-tiles-5"><div class="hub-tile" onclick="alert('EU features coming soon')">AI Size Finder</div><div class="hub-tile" onclick="alert('EU features coming soon')">My Sizes</div><div class="hub-tile" onclick="alert('EU features coming soon')">Brand Intelligence</div><div class="hub-tile" onclick="alert('EU features coming soon')">History</div><div class="hub-tile" onclick="alert('EU features coming soon')">Converters</div></div></div></div>
  <div id="us-hub" class="screen"><div class="hub-container"><div class="hub-header"><div style="font-size:60px">üá∫üá∏</div><h2 class="hub-title">US Hub</h2><p class="hub-subtitle">United States sizing & tracking</p></div><div class="hub-tiles-5"><div class="hub-tile" onclick="alert('US features coming soon')">AI Size Finder</div><div class="hub-tile" onclick="alert('US features coming soon')">My Sizes</div><div class="hub-tile" onclick="alert('US features coming soon')">Brand Intelligence</div><div class="hub-tile" onclick="alert('US features coming soon')">History</div><div class="hub-tile" onclick="alert('US features coming soon')">Converters</div></div></div></div>
  <div id="ca-hub" class="screen"><div class="hub-container"><div class="hub-header"><div style="font-size:60px">üá®üá¶</div><h2 class="hub-title">Canada Hub</h2><p class="hub-subtitle">Canadian sizing & tracking</p></div><div class="hub-tiles-5"><div class="hub-tile" onclick="alert('CA features coming soon')">AI Size Finder</div><div class="hub-tile" onclick="alert('CA features coming soon')">My Sizes</div><div class="hub-tile" onclick="alert('CA features coming soon')">Brand Intelligence</div><div class="hub-tile" onclick="alert('CA features coming soon')">History</div><div class="hub-tile" onclick="alert('CA features coming soon')">Converters</div></div></div></div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="goHome()">Home</button>
    <button class="nav-item" onclick="goToMiStats()">MiStats</button>
    <button class="nav-item" onclick="goToSettings()">Settings</button>
    <button class="nav-item" onclick="goToHelp()">Help</button>
    <button class="nav-item" onclick="goBack()">Back</button>
  </div>

      <script>
  // --- State ---
  let currentScreen = 'home';
  let navigationHistory = ['home'];
  let selectedBodyType = 'standard';
  let selectedUnit = 'cm';
  let currentProfile = 'Emma Morris';

  // --- Profiles (minimal) ---
  const profileData = {
    'Emma Morris': {
      name:'Emma Morris',
      gender:'female',
      measurements:{ weight:80, chest:36, waist:34, hips:38 },
      history:[]
    }
  };

  // --- Simple brand DB (extend as needed) ---
  const BRAND_SIZE_DATABASE = {
    'ASOS': {
      notes:'UK sizes, runs slightly large',
      categories:{
        "Women's Tops": { '12':{bust:36,waist:30,hips:38}, '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
        "Women's Dresses": { '12':{bust:36,waist:30,hips:38}, '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
        "Women's Jeans": { '12':{waist:30,hips:38}, '14':{waist:32,hips:40}, '16':{waist:34,hips:42}, '18':{waist:36,hips:44} }
      }
    },
    'Zara': {
      notes:'Trims closer; consider one up for fitted items',
      categories:{
        "Women's Tops": { 'L':{bust:37,waist:30,hips:39}, 'XL':{bust:39,waist:32,hips:41} },
        "Women's Dresses": { 'L':{bust:37,waist:30,hips:39}, 'XL':{bust:39,waist:32,hips:41} },
        "Women's Jeans": { '40':{waist:31,hips:39}, '42':{waist:33,hips:41}, '44':{waist:35,hips:43} }
      }
    },
    'H&M': {
      notes:'Often true to size',
      categories:{
        "Women's Tops": { 'M':{bust:36,waist:30,hips:38}, 'L':{bust:38,waist:32,hips:40} },
        "Women's Dresses": { 'M':{bust:36,waist:30,hips:38}, 'L':{bust:38,waist:32,hips:40} },
        "Women's Jeans": { '12':{waist:30,hips:38}, '14':{waist:32,hips:40}, '16':{waist:34,hips:42} }
      }
    },
    'Marks & Spencer': {
      notes:'Consistent charts; generous at hips',
      categories:{
        "Women's Tops": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
        "Women's Dresses": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
        "Women's Jeans": { '14':{waist:32,hips:40}, '16':{waist:34,hips:42}, '18':{waist:36,hips:44} }
      }
    },
    'Next': {
      notes:'Between ASOS and M&S; fairly true',
      categories:{
        "Women's Tops": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
        "Women's Dresses": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
        "Women's Jeans": { '14':{waist:32,hips:40}, '16':{waist:34,hips:42}, '18':{waist:36,hips:44} }
      }
    }
  };

  // --- Utility: switch screens ---
  function goToScreen(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add('active');
    currentScreen = id;
    navigationHistory.push(id);
    updateBottomNav();
  }
  function updateBottomNav(){
    const items = document.querySelectorAll('.bottom-nav .nav-item');
    items.forEach(i=>i.classList.remove('active'));
    const map = {home:0, mistats:1, 'uk-settings':2, help:3};
    const idx = map[currentScreen];
    if(idx!==undefined) items[idx].classList.add('active');
  }
  function goBack(){
    navigationHistory.pop(); // current
    const prev = navigationHistory.pop() || 'home';
    goToScreen(prev);
  }
  function goHome(){ goToScreen('home'); }
  function goToMiStats(){ goToScreen('mistats'); } // simple placeholder screen id
  function goToSettings(){ goToScreen('uk-settings'); }
  function goToHelp(){ goToScreen('help'); }

  // --- Region entry ---
  function enterHub(region){
    if(region==='UK') goToScreen('uk-hub');
    else if(region==='EU') goToScreen('eu-hub');
    else if(region==='US') goToScreen('us-hub');
    else if(region==='CA') goToScreen('ca-hub');
  }

  // --- Debug panel ---
  function toggleDebugPanel(){
    document.getElementById('debug-panel').classList.toggle('open');
  }
  function refreshDebug(){
    const p = profileData[currentProfile];
    const msg = [
      `Time: ${new Date().toLocaleTimeString()}`,
      `Profile: ${currentProfile}`,
      `Body type: ${selectedBodyType}`,
      `Unit: ${selectedUnit}`,
      `Measurements (in): B${p.measurements.chest} W${p.measurements.waist} H${p.measurements.hips}`
    ].join(' ‚Ä¢ ');
    document.getElementById('debug-info').innerText = msg;
    document.getElementById('system-status-dot').className='status-dot status-online';
    document.getElementById('system-status-text').innerText='Intelligent sizing system ready';
    document.getElementById('last-update-time').innerText=new Date().toLocaleString();
  }

  // --- Pills (body type & unit) ---
  document.addEventListener('click',(e)=>{
    if(e.target.matches('#bodytype-pills .pill')){
      document.querySelectorAll('#bodytype-pills .pill').forEach(p=>p.classList.remove('active'));
      e.target.classList.add('active');
      selectedBodyType = e.target.dataset.type;
      refreshDebug();
    }
    if(e.target.matches('#unit-pills .pill')){
      document.querySelectorAll('#unit-pills .pill').forEach(p=>p.classList.remove('active'));
      e.target.classList.add('active');
      selectedUnit = e.target.dataset.unit;
      refreshDebug();
    }
  });

  // --- Populate My Sizes & Brand Notes ---
  function renderMySizes(){
    const grid = document.getElementById('my-sizes-grid');
    const p = profileData[currentProfile].measurements;
    const results = [];

    // Quick pass over known brands/categories to compute closest size
    Object.entries(BRAND_SIZE_DATABASE).forEach(([brand, data])=>{
      const cats = data.categories;
      Object.entries(cats).forEach(([cat, sizes])=>{
        const rec = pickBestSize(cat, sizes, p);
        if(rec) results.push({brand,cat,rec,notes:data.notes});
      });
    });

    if(results.length===0){
      grid.innerHTML = `<div class="brand-card" style="grid-column:1/-1">No sizes yet. Try the AI Size Finder.</div>`;
      return;
    }

    grid.innerHTML = results.slice(0,8).map(r=>{
      const label = `${r.brand} ‚Äî ${r.cat}`;
      const size = r.rec.size;
      const conf = Math.round(r.rec.confidence*100);
      return `
        <div class="brand-card">
          <div class="brand-name">${label}</div>
          <div><span class="brand-size">${size}</span><span class="confidence-indicator">${conf}%</span></div>
          <div style="font-size:13px;color:var(--muted)">${r.notes}</div>
        </div>`;
    }).join('');
  }

  function renderBrandNotes(){
    const grid = document.getElementById('brand-notes-grid');
    grid.innerHTML = Object.entries(BRAND_SIZE_DATABASE).map(([name,data])=>`
      <div class="brand-card">
        <div class="brand-name">${name}</div>
        <div style="font-size:13px;color:var(--muted)">${data.notes}</div>
      </div>
    `).join('');
  }

  // --- History ---
  const historyItems = [];
  function saveToHistory(){
    const brand = document.getElementById('uk-brand-select').value || '‚Äî';
    const cat = document.getElementById('uk-category-select').value || '‚Äî';
    const resultEl = document.getElementById('size-result');
    const line = resultEl.style.display==='none' ? 'No recommendation yet' : resultEl.dataset.summary;
    historyItems.unshift({brand,cat,summary:line,date:new Date()});
    renderHistory();
    alert('Saved to history');
  }
  function renderHistory(){
    const list = document.getElementById('uk-history-list');
    if(historyItems.length===0){
      list.innerHTML = `<div class="history-item"><div><strong>No history yet</strong><br><span class="history-date">Use the AI Size Finder first</span></div></div>`;
      return;
    }
    list.innerHTML = historyItems.slice(0,10).map(h=>{
      return `<div class="history-item">
        <div><strong>${h.brand} - ${h.cat}</strong><br><span class="history-date">${h.summary} ‚Ä¢ ${h.date.toLocaleString()}</span></div>
      </div>`;
    }).join('');
  }

  // --- AI Size Finder (simple diff-based) ---
  function getMySize(){
    const brand = document.getElementById('uk-brand-select').value;
    const cat = document.getElementById('uk-category-select').value;
    const fit = document.getElementById('uk-fit-select').value || 'Standard';
    const out = document.getElementById('size-result');

    if(!brand || !cat){
      out.style.display='block';
      out.style.borderColor='var(--orange)';
      out.innerHTML = 'Please choose a brand and category.';
      out.dataset.summary = 'Incomplete request';
      return;
    }
    const db = BRAND_SIZE_DATABASE[brand];
    if(!db || !db.categories[cat]){
      out.style.display='block';
      out.style.borderColor='var(--orange)';
      out.innerHTML = 'No chart for this brand/category yet.';
      out.dataset.summary = 'No chart';
      return;
    }

    const p = profileData[currentProfile].measurements;
    const rec = pickBestSize(cat, db.categories[cat], p, fit);

    if(!rec){
      out.style.display='block';
      out.style.borderColor='var(--orange)';
      out.innerHTML = 'Couldn‚Äôt find a close match.';
      out.dataset.summary = 'No match';
      return;
    }

    const confPct = Math.round(rec.confidence*100);
    out.style.display='block';
    out.style.borderColor='var(--green)';
    out.innerHTML = `<strong>Recommended Size:</strong> ${rec.size} <span class="confidence-indicator">${confPct}% match</span>
      <div style="margin-top:8px;font-size:14px;color:var(--muted)">${brand} ‚Ä¢ ${cat} ‚Ä¢ Fit: ${fit}</div>
      <div style="margin-top:8px;font-size:13px">Why: minimal difference to your Waist/Hips/Bust for this category.</div>`;
    out.dataset.summary = `Size ${rec.size}, ${confPct}% match`;
  }

  // Core matching helper
  function pickBestSize(category, sizesMap, meas, fit='Standard'){
    let best = null;
    const keys = Object.keys(sizesMap);
    keys.forEach(size=>{
      const chart = sizesMap[size];
      // Choose relevant dims by category
      let diffs = [];
      if(category.includes('Jeans')){
        if(chart.waist!==undefined) diffs.push(Math.abs(chart.waist - meas.waist));
        if(chart.hips!==undefined) diffs.push(Math.abs(chart.hips - meas.hips));
      }else if(category.includes('Tops')){
        if(chart.bust!==undefined) diffs.push(Math.abs(chart.bust - meas.chest));
        if(chart.waist!==undefined) diffs.push(Math.abs(chart.waist - meas.waist));
      }else if(category.includes('Dresses')){
        if(chart.bust!==undefined) diffs.push(Math.abs(chart.bust - meas.chest));
        if(chart.waist!==undefined) diffs.push(Math.abs(chart.waist - meas.waist));
        if(chart.hips!==undefined) diffs.push(Math.abs(chart.hips - meas.hips));
      }else{
        // Fallback: try all
        Object.entries(chart).forEach(([k,v])=>{
          if(k==='bust') diffs.push(Math.abs(v - meas.chest));
          if(k==='waist') diffs.push(Math.abs(v - meas.waist));
          if(k==='hips') diffs.push(Math.abs(v - meas.hips));
        });
      }
      const avgDiff = diffs.length? (diffs.reduce((a,b)=>a+b,0)/diffs.length): 999;

      // Fit tweak: snug prefers slightly smaller, relaxed prefers slightly bigger
      // (This is a gentle nudge, not a hard rule.)
      let bias = 0;
      if(fit==='Snug') bias = -0.3;
      if(fit==='Relaxed') bias = 0.3;

      const score = avgDiff + bias; // lower is better
      if(!best || score < best.score){
        // Normalise as confidence (arbitrary: 0‚Äì4 inches window)
        const confidence = Math.max(0, 1 - (avgDiff/4));
        best = { size, score, confidence };
      }
    });
    return best;
  }

  // --- Help actions ---
  function reportIssue(){ alert('Thanks! A feedback form will be added here.'); }

  function saveMeasurementsToProfile(){
    const p = profileData[currentProfile];
    const n = (id)=>Number(document.getElementById(id).value);
    const w = n('weight'); const c = n('chest'); const wa = n('waist'); const h = n('hips');
    if([w,c,wa,h].some(x=>Number.isNaN(x)||x<=0)){ alert('Please enter valid numbers'); return; }
    p.measurements = { weight:w, chest:c, waist:wa, hips:h };
    alert('Measurements saved.');
    renderMySizes();
    refreshDebug();
  }

  // --- Init ---
  function init(){
    // Profile select
    const sel = document.getElementById('measurement-profile-select');
    sel.innerHTML = Object.keys(profileData).map(n=>`<option>${n}</option>`).join('');
    sel.value = currentProfile;
    sel.addEventListener('change', (e)=>{ currentProfile = e.target.value; renderMySizes(); refreshDebug(); });

    // Home ready
    setTimeout(()=>{ refreshDebug(); }, 300);

    // Pre-fill settings inputs
    const p = profileData[currentProfile].measurements;
    document.getElementById('weight').value = p.weight;
    document.getElementById('chest').value = p.chest;
    document.getElementById('waist').value = p.waist;
    document.getElementById('hips').value = p.hips;

    // Render sections
    renderMySizes();
    renderBrandNotes();
    renderHistory();
  }
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
